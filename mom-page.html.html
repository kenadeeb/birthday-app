<script>
    // DOM Elements
    const welcomeScreen = document.getElementById('welcomeScreen');
    const appContent = document.getElementById('appContent');
    const startButton = document.getElementById('startButton');
    const chatContainer = document.getElementById('chatContainer');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileIcon = document.getElementById('fileIcon');
    const deleteFile = document.getElementById('deleteFile');
    const messageStatus = document.getElementById('messageStatus');
    const connectionStatus = document.getElementById('connectionStatus');

    let socket = null;
    let selectedFiles = [];
    
    // Function to initialize socket connection
    function initializeSocket() {
        // REPLACE THIS WITH YOUR ACTUAL RENDER URL
        const backendUrl = 'https://birthday-app-backend-tt9f.onrender.com';
        
        console.log('Connecting to backend:', backendUrl);
        
        socket = io(backendUrl, {
            transports: ['websocket', 'polling'],
            timeout: 10000
        });
        
        socket.on('connect', () => {
            console.log('✅ Connected to server successfully!');
            connectionStatus.innerHTML = '<i class="fas fa-check"></i> Connected';
            connectionStatus.className = 'connection-status connected';
        });
        
        socket.on('disconnect', (reason) => {
            console.log('❌ Disconnected from server:', reason);
            connectionStatus.innerHTML = '<i class="fas fa-times"></i> Disconnected';
            connectionStatus.className = 'connection-status disconnected';
        });
        
        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            connectionStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Connection Failed';
            connectionStatus.className = 'connection-status disconnected';
        });
    }
    
    // Create confetti effect
    function createConfetti() {
        const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#ff8e6b', '#6bffb8'];
        for (let i = 0; i < 100; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            document.body.appendChild(confetti);
            
            setTimeout(() => {
                confetti.remove();
            }, 5000);
        }
    }
    
    // File type icons mapping
    const fileIcons = {
        'image': 'fa-image',
        'pdf': 'fa-file-pdf',
        'word': 'fa-file-word',
        'excel': 'fa-file-excel',
        'video': 'fa-file-video',
        'audio': 'fa-file-audio',
        'archive': 'fa-file-archive',
        'default': 'fa-file'
    };
    
    // Get file icon based on type
    function getFileIcon(file) {
        const type = file.type.split('/')[0];
        if (fileIcons[type]) return fileIcons[type];
        
        if (file.type.includes('pdf')) return fileIcons.pdf;
        if (file.type.includes('word') || file.type.includes('document')) return fileIcons.word;
        if (file.type.includes('excel') || file.type.includes('spreadsheet')) return fileIcons.excel;
        if (file.type.includes('zip') || file.type.includes('rar')) return fileIcons.archive;
        
        return fileIcons.default;
    }
    
    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Convert file to base64
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
    
    // Show file preview
    function showFilePreview(file) {
        selectedFiles = [file];
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileIcon.className = `fas ${getFileIcon(file)} file-icon`;
        filePreview.style.display = 'block';
    }
    
    // Clear file preview
    function clearFilePreview() {
        selectedFiles = [];
        filePreview.style.display = 'none';
        fileInput.value = '';
    }
    
    // Function to add message to chat
    function addMessage(message, isUser, isFile = false, fileInfo = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'} ${isFile ? 'file-message' : ''}`;
        
        if (isFile && fileInfo) {
            messageDiv.innerHTML = `
                <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">
                    ${isUser ? 'You' : 'Adeeb'} • File
                </div>
                <p>${message}</p>
                <div style="margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 5px;">
                    <i class="fas ${fileInfo.icon}"></i> ${fileInfo.name} (${fileInfo.size})
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">
                    ${isUser ? 'You' : 'Adeeb'}
                </div>
                <p>${message}</p>
            `;
        }
        
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Function to send message to backend
    async function sendMessageToBackend(message, files = []) {
        if (!socket || !socket.connected) {
            addMessage('⚠️ Not connected. Please wait for connection...', false);
            return false;
        }
        
        try {
            // Process files to base64
            const processedFiles = await Promise.all(
                files.map(async (file) => {
                    const dataUrl = await fileToBase64(file);
                    return {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        data: dataUrl, // Full data URL
                        url: dataUrl
                    };
                })
            );
            
            const messageData = {
                text: message,
                sender: 'Rafat Fatima',
                timestamp: new Date(),
                isFile: files.length > 0,
                files: processedFiles,
                expiresAt: new Date(Date.now() + 2 * 60 * 60 * 1000)
            };
            
            console.log('Sending message with files:', {
                hasFiles: files.length > 0,
                fileCount: files.length,
                fileNames: files.map(f => f.name)
            });
            
            // Send via Socket.io
            socket.emit('sendMessage', messageData);
            
            // Also send via REST API as backup
            fetch('https://your-backend-url.onrender.com/api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(messageData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Message saved via API:', data);
            })
            .catch(error => {
                console.error('Error saving message via API:', error);
            });
            
            return true;
        } catch (error) {
            console.error('Error processing files:', error);
            addMessage('❌ Error sending file. Please try again.', false);
            return false;
        }
    }
    
    // Function to handle user message
    async function handleUserMessage() {
        const message = userInput.value.trim();
        const hasFiles = selectedFiles.length > 0;
        
        if (message === '' && !hasFiles) return;
        
        // Show sending status
        messageStatus.textContent = "Sending...";
        messageStatus.style.color = "#ff9800";
        
        try {
            if (hasFiles) {
                const success = await sendMessageToBackend(
                    message || `Sent: ${selectedFiles[0].name}`, 
                    selectedFiles
                );
                
                if (success) {
                    addMessage(message || `Sent ${selectedFiles[0].name}`, true, true, {
                        name: selectedFiles[0].name,
                        size: formatFileSize(selectedFiles[0].size),
                        icon: getFileIcon(selectedFiles[0])
                    });
                    clearFilePreview();
                    
                    messageStatus.textContent = "✅ File sent to Adeeb!";
                    messageStatus.style.color = "#25D366";
                }
            } else {
                const success = await sendMessageToBackend(message);
                if (success) {
                    addMessage(message, true);
                    userInput.value = '';
                    
                    messageStatus.textContent = "✅ Message sent to Adeeb!";
                    messageStatus.style.color = "#25D366";
                }
            }
        } catch (error) {
            messageStatus.textContent = "❌ Failed to send. Please try again.";
            messageStatus.style.color = "#f44336";
        }
        
        // Clear status after 3 seconds
        setTimeout(() => {
            messageStatus.textContent = "";
        }, 3000);
    }
    
    // Event listeners
    startButton.addEventListener('click', function() {
        welcomeScreen.style.display = 'none';
        appContent.style.display = 'block';
        createConfetti();
        initializeSocket();
    });
    
    sendBtn.addEventListener('click', handleUserMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleUserMessage();
        }
    });
    
    uploadBtn.addEventListener('click', () => {
        fileInput.click();
    });
    
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            
            // Check file size (limit to 10MB for demo)
            if (file.size > 10 * 1024 * 1024) {
                messageStatus.textContent = "❌ File too large (max 10MB)";
                messageStatus.style.color = "#f44336";
                setTimeout(() => {
                    messageStatus.textContent = "";
                }, 3000);
                return;
            }
            
            showFilePreview(file);
        }
    });
    
    deleteFile.addEventListener('click', clearFilePreview);
    
    // Load previous messages when page loads
    window.addEventListener('load', () => {
        createConfetti();
        
        // Load previous messages from API
        fetch('https://your-backend-url.onrender.com/api/messages')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(messages => {
                console.log('Loaded previous messages:', messages.length);
                messages.forEach(message => {
                    if (message.sender === 'Adeeb') {
                        if (message.isFile && message.files && message.files.length > 0) {
                            addMessage(message.text, false, true, {
                                name: message.files[0].name,
                                size: formatFileSize(message.files[0].size),
                                icon: getFileIcon({ type: message.files[0].type })
                            });
                        } else {
                            addMessage(message.text, false);
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading messages:', error);
            });
    });
</script>
